// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Shop {
  shopID        Int     @id @default(autoincrement())
  shopFname     String
  shopLname     String
  shopGender    String
  shopEmail     String  @unique
  shopPhone     String
  shopPass      String
  shopName      String
  shopDetail  String?
  shopLocation  String
  shopPic       String?
  shopQR        String?
  shopOpenTime  String  @default("09:00")
  shopCloseTime String  @default("18:00")
  shopOpen      Boolean @default(false)

  history  ShopHistory[]
  sessions Session[]
  foods    Food[]
  foodgenre FoodGenre[]
  optionGroups  OptionGroup[]
  cart  Cart[]

  orders Order[]
}

model Admin {
  adminID    Int     @id @default(autoincrement())
  adminFname String
  adminLname String
  adminEmail String  @unique
  adminPhone String
  adminPass  String
  adminPic   String?

  sessions Session[]
}

model Customer {
  customerID    Int     @id @default(autoincrement())
  customerFname String
  customerLname String
  customerEmail String  @unique
  customerPhone String
  customerPass  String
  customerGender  String
  customerPic   String?

  sessions Session[]
  history  CustomerHistory[]
  cart  Cart[]

  orders Order[]
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  shopId    Int?
  shop      Shop?    @relation(fields: [shopId], references: [shopID], onDelete: Cascade)
  
  adminId   Int?
  admin     Admin?   @relation(fields: [adminId], references: [adminID], onDelete: Cascade)

  customerId   Int?
  customer     Customer?   @relation(fields: [customerId], references: [customerID], onDelete: Cascade)

  @@index([token])
  @@index([shopId])
  @@index([adminId])
  @@index([customerId])
}

model ShopHistory {
  shopHistoryID Int @id @default(autoincrement())
  shopID    Int
  shopLogin     DateTime
  shopLogout    DateTime?

  shop      Shop     @relation(fields: [shopID], references: [shopID])
}

model CustomerHistory {
  customerHistoryID Int @id @default(autoincrement())
  customerID    Int
  customerLogin     DateTime
  customerLogout    DateTime?

  customer      Customer     @relation(fields: [customerID], references: [customerID])
}

model Food {
  foodID       Int @id @default(autoincrement())
  shopID       Int
  foodName     String
  foodDetails  String?
  foodPrice    Float
  foodPic      String
  foodGenreID  Int
  foodStatus   Boolean @default(true)

  foodOptionGroups FoodOptionGroup[]
  cartItem  CartItem[]

  shop   Shop      @relation(fields: [shopID], references: [shopID])
  genre  FoodGenre @relation(fields: [foodGenreID], references: [fGenreID])

  orderItems OrderItem[]
}

model FoodGenre {
  fGenreID Int @id @default(autoincrement())
  fGenreName String
  shopID  Int

  shop  Shop  @relation(fields: [shopID], references: [shopID])
  foods      Food[]
}

model OptionGroup {
  ogID       Int @id @default(autoincrement())
  shopID     Int

  ogName     String
  ogMultiple Boolean
  ogForce    Boolean

  options    Option[]
  foodOptionGroups FoodOptionGroup[]

  shop Shop @relation(fields: [shopID], references: [shopID])

  @@unique([shopID, ogName])
}

model FoodOptionGroup {
  foodID Int
  ogID   Int

  food Food @relation(fields: [foodID], references: [foodID], onDelete: Cascade)
  optionGroup OptionGroup @relation(fields: [ogID], references: [ogID], onDelete: Cascade)

  @@id([foodID, ogID])
}


model Option {
  opID    Int @id @default(autoincrement())
  ogID    Int

  opName  String
  opPrice Float

  optionGroup OptionGroup @relation(fields: [ogID], references: [ogID], onDelete: Cascade)

  options CartItemOption[]

  @@index([ogID])
  orderItemOptions OrderItemOption[]
}

model Cart {
  cartID     Int @id @default(autoincrement())
  customerID Int @unique
  shopID     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  items      CartItem[]

  customer Customer @relation(fields: [customerID], references: [customerID], onDelete: Cascade)
  shop     Shop     @relation(fields: [shopID], references: [shopID], onDelete: Cascade)

  @@index([shopID])
}


model CartItem {
  cartItemID       Int @id @default(autoincrement())
  cartID           Int
  foodID           Int
  cartItemQuantity Int
  cartItemNote     String?
  foodPriceSnapshot Float

  cart    Cart @relation(fields: [cartID], references: [cartID], onDelete: Cascade)
  food    Food @relation(fields: [foodID], references: [foodID])

  options CartItemOption[]

  @@index([cartID])
  @@index([foodID])
}

model CartItemOption {
  cartItemOptionID Int @id @default(autoincrement())
  cartItemID       Int
  optionID         Int
  optionPriceSnapshot Float

  cartItem CartItem @relation(fields: [cartItemID], references: [cartItemID], onDelete: Cascade)
  option   Option   @relation(fields: [optionID], references: [opID])

  @@unique([cartItemID, optionID])
}

model Order {
  orderID     Int      @id @default(autoincrement())
  customerID  Int
  shopID      Int
  totalPrice  Float
  status      String
  createdAt   DateTime @default(now())

  customer    Customer @relation(fields: [customerID], references: [customerID])
  shop        Shop     @relation(fields: [shopID], references: [shopID])
  items       OrderItem[]
  payment     Payment?

  @@index([customerID])
  @@index([shopID])
}

model OrderItem {
  orderItemID Int @id @default(autoincrement())
  orderID     Int
  foodID      Int

  foodNameSnapshot  String
  foodPriceSnapshot Float
  quantity          Int
  note              String?

  order   Order @relation(fields: [orderID], references: [orderID], onDelete: Cascade)
  food    Food  @relation(fields: [foodID], references: [foodID])
  options OrderItemOption[]

  @@index([orderID])
  @@index([foodID])
}

model OrderItemOption {
  id Int @id @default(autoincrement())
  orderItemID Int

  optionID               Int
  optionNameSnapshot     String
  optionPriceSnapshot    Float

  orderItem OrderItem @relation(fields: [orderItemID], references: [orderItemID], onDelete: Cascade)
  option    Option    @relation(fields: [optionID], references: [opID])

  @@index([orderItemID])
  @@index([optionID])
}

model Payment {
  paymentID   Int      @id @default(autoincrement())
  orderID     Int      @unique
  amount      Float
  slipPic     String?
  status      Boolean  @default(false)
  paidAt      DateTime?

  order Order @relation(fields: [orderID], references: [orderID], onDelete: Cascade)
}